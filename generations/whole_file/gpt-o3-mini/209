import * as THREE from "three";

const world = Globe()
  .globeImageUrl("img/world.topo.200412.3x21600x10800.png")
  .bumpImageUrl("img/earth-topology.png")
  .backgroundImageUrl("img/night-sky.png")(document.getElementById("globeViz"));

// 自定义地球材质
const globeMaterial = world.globeMaterial();
new THREE.TextureLoader().load("img/earth-water.png", (texture) => {
  globeMaterial.specularMap = texture;
  globeMaterial.specular = new THREE.Color("grey");
  globeMaterial.shininess = 10;
});

const directionalLight = world
  .lights()
  .find((light) => light.type === "DirectionalLight");
if (directionalLight) {
  let angle = 0;
  const radius = 360;

  function animateLight() {
    angle += (2 * Math.PI) / 6000; // 60秒内完成一个完整的圆圈
    directionalLight.position.set(
      radius * Math.cos(angle),
      10,
      radius * Math.sin(angle)
    );
    requestAnimationFrame(animateLight);
  }

  animateLight();
}



// “this”

const colorScale = d3.scaleSequentialSqrt(d3.interpolateYlOrRd);

// 人均GDP（避免人口少的国家）
const getVal = (feat) =>
  feat.properties.GDP_MD_EST / Math.max(1e5, feat.properties.POP_EST);

fetch("../datasets/ne_110m_admin_0_countries.geojson")
  .then((res) => res.json())
  .then((countries) => {
    const maxVal = Math.max(...countries.features.map(getVal));
    colorScale.domain([0, maxVal]);

    // 将地球国家图层添加到现有的地球仪中
    world
      .globeImageUrl("//unpkg.com/three-globe/example/img/earth-night.jpg")
      .backgroundImageUrl("//unpkg.com/three-globe/example/img/night-sky.png")
      .lineHoverPrecision(0)
      .polygonsData(
        countries.features.filter((d) => d.properties.ISO_A2 !== "AQ")
      )
      .polygonAltitude(0.06)
      .polygonCapColor((feat) => colorScale(getVal(feat)))
      .polygonSideColor(() => "rgba(0, 100, 0, 0.15)")
      .polygonStrokeColor(() => "#111")
      .polygonLabel(
        ({ properties: d }) => `
      <b>${d.ADMIN} (${d.ISO_A2}):</b> <br />
      GDP: <i>${d.GDP_MD_EST}</i> M$<br/>
      Population: <i>${d.POP_EST}</i>
    `
      )
      .onPolygonHover((hoverD) =>
        world
          .polygonAltitude((d) => (d === hoverD ? 0.12 : 0.06))
          .polygonCapColor((d) =>
            d === hoverD ? "steelblue" : colorScale(getVal(d))
          )
      )
      .polygonsTransitionDuration(300);
  });